generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ENUMS ==========
enum TipoOcorrencia {
  QUEDA_ARVORE
  BLOQUEIO_VIA
  ACIDENTE
  ENCHENTE
  DESLIZAMENTO
  INCENDIO
  VANDALISMO
  ILUMINACAO
  BURACO
  OUTROS
}

enum Prioridade {
  BAIXA
  MEDIA
  ALTA
  CRITICA
}

enum StatusOcorrencia {
  NOVO
  EM_ANALISE      // ✅ ADICIONADO
  EM_ATENDIMENTO
  CONCLUIDO
  CANCELADO
}

enum UserStatus {
  ATIVO
  INATIVO
  PENDENTE
}

// ========== MODELS ==========
model User {
  id              String      @id @default(uuid())
  nome            String
  email           String      @unique
  senha           String
  cargo           String
  departamento    String
  telefone        String
  avatar          String?
  status          UserStatus  @default(ATIVO)
  permissoes      String[]
  ultimoAcesso    DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  ocorrenciasCriadas     Occurrence[] @relation("CriadoPor")
  ocorrenciasResponsavel Occurrence[] @relation("Responsavel")
  
  @@map("users")
}

model Occurrence {
  id              String           @id @default(uuid())
  tipo            TipoOcorrencia
  local           String
  endereco        String
  bairro          String?          // ✅ ADICIONADO
  latitude        Float?
  longitude       Float?
  status          StatusOcorrencia @default(NOVO)
  prioridade      Prioridade       @default(MEDIA)
  descricao       String?
  fotos           String[]
  
  criadoPorId     String
  criadoPor       User             @relation("CriadoPor", fields: [criadoPorId], references: [id])
  
  responsavelId   String?
  responsavel     User?            @relation("Responsavel", fields: [responsavelId], references: [id])
  
  dataOcorrencia  DateTime         @default(now())
  dataAtendimento DateTime?
  dataConclusao   DateTime?
  tempoResposta   Int?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  historico       OccurrenceHistory[] // ✅ ADICIONADO relação
  
  @@map("occurrences")
}

model OccurrenceHistory {
  id              String     @id @default(uuid())
  occurrenceId    String
  occurrence      Occurrence @relation(fields: [occurrenceId], references: [id], onDelete: Cascade)
  statusAnterior  String
  statusNovo      String
  observacao      String?
  modificadoPor   String
  createdAt       DateTime   @default(now())
  
  @@map("occurrence_history")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String
  acao       String
  entidade   String
  detalhes   Json?    // ✅ Aqui você coloca occurrenceId, etc
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  
  @@map("audit_logs")
}